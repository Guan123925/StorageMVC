
@{
    ViewBag.Title = "AddProjectAndStage";
    Layout = "~/Views/Master/Project/ProjectAddOrUpdate.cshtml";
}

<script>
    $().ready(function () {
         ProjectBackFill();
         StageDetail();
         ProjectBand();
         MarkBand();
         TestBand();
         TechBand();
         ProductBand();
     })

    
    function ChangeDateFormat(val) {
        if (val != null) {
            var date = new Date(parseInt(val.replace("/Date(", "").replace(")/", ""), 10));
            //月份为0-11，所以+1，月份小于10时补个0
            var month = date.getMonth() + 1 < 10 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1;
            var currentDate = date.getDate() < 10 ? "0" + date.getDate() : date.getDate();
            return date.getFullYear() + "-" + month + "-" + currentDate;
        }
        return "";
    }

      function StageDelete(PlanId) {
          if (confirm("确定要删除么？")) {
              $.ajax({
                  url:"/Project/DeleteStage",
                  data: {
                      PlanId: PlanId
                  },
                  type: "post",
                  datatype: "json",
                  success: function (res) {
                      if (res.IsRegistSuccess) {
                          alert(res.Message);
                      }
                      else {
                          alert(res.Message);
                      }
                  }
                 })
                }
    }

    function StageUpdtae(PlanId) {
        window.location = "/Project/StageUpdate?PlanId=" + PlanId;
    }

    function ProjectBackFill() {
        var ProjectId = $("#hidProjectId").val();

        $.ajax({
            url: "/Project/ProjectDetail",
            data: {
                ProjectId:ProjectId
            },
            type: "post",
            datatype: "json",
            success: function (res) {
                $(res.Project).each(function () {
                    $("#txtNumber").val(res.Project[0].ProjectNumber);
                    $("#txtName").val(res.Project[0].ProjectName);
                    $("#txtDetail").val(res.Project[0].ProjectDescribe);
                    $("#txtStartTime").val(ChangeDateFormat(res.Project[0].ProjectStartTime));
                    $("#txtOffTime").val(ChangeDateFormat(res.Project[0].ProjectOutTime));
                    ProjectStageIdOrBackFill = res.Project[0].ProjectStage;
                })
            }
        })
    }

    function ProjectUpdate() {
        var ProjectId = $("#hidProjectId").val();
        var ProjectNumber = $("#txtNumber").val();
        var ProjectName = $("#txtName").val();
        var ProjectDescribe = $("#txtDetail").val();
        var ProjectStaffId = $("#selProject").val();
        var TechStaffId = $("#selTech").val();
        var ProductStaffId = $("#selProduct").val();
        var TestStaffId = $("#selTest").val();
        var MarketStaffId = $("#selMark").val();
        var ProjectStartTime = $("#txtStartTime").val();
        var ProjectOutTime = $("#txtOffTime").val();
        var ProjectStage = 0;

        $.ajax({
            url: "/Project/UpdateProject",
            data: {
                ProjectId:ProjectId,
                ProjectNumber: ProjectNumber,
                ProjectName: ProjectName,
                ProjectDescribe: ProjectDescribe,
                ProjectStaffId: ProjectStaffId,
                TechStaffId: TechStaffId,
                ProductStaffId: ProductStaffId,
                TestStaffId: TestStaffId,
                MarketStaffId: MarketStaffId,
                ProjectStartTime: ProjectStartTime,
                ProjectOutTime: ProjectOutTime,
                ProjectStage:ProjectStage
            },
            type: "post",
            datatype: "json",
            success: function (res) {
                if (res.IsRegistSuccess) {
                    alert(res.Message);
                }
                else {
                    alert(res.Message);
                }
            }
        })
    }

    //function AddStage() {
    //    window.location = "/Project/StageUpdate?ProjectStageId="+;
    //}

    function ProjectBand() {
        var DepartId = 1;

        $.ajax({
            url: "/Project/BandProjectbinding",
            data: {
                DepartId: DepartId
            },
            type: "post",
            datatype: "json",
            success: function (res) {
                var list = "";
                $(res.info).each(function () {
                    list += "<option value='" + this.Id + "' >" + this.PositName + "</option>";
                })
                $("#selProject").append(list);
            }
        })
    }

    function TechBand() {
        var DepartId = 2;

        $.ajax({
            url: "/Project/BandProjectbinding",
            data: {
                DepartId: DepartId
            },
            type: "post",
            datatype: "json",
            success: function (res) {
                var list = "";
                $(res.info).each(function () {
                    list += "<option value='" + this.Id + "' >" + this.PositName + "</option>";
                })
                $("#selTech").append(list);
            }
        })
    }

    function ProductBand() {
        var DepartId = 3;

        $.ajax({
            url: "/Project/BandProjectbinding",
            data: {
                DepartId: DepartId
            },
            type: "post",
            datatype: "json",
            success: function (res) {
                var list = "";
                $(res.info).each(function () {
                    list += "<option value='" + this.Id + "' >" + this.PositName + "</option>";
                })
                $("#selProduct").append(list);
            }
        })
    }

    function TestBand() {
        var DepartId = 4;

        $.ajax({
            url: "/Project/BandProjectbinding",
            data: {
                DepartId: DepartId
            },
            type: "post",
            datatype: "json",
            success: function (res) {
                var list = "";
                $(res.info).each(function () {
                    list += "<option value='" + this.Id + "' >" + this.PositName + "</option>";
                })
                $("#selTest").append(list);
            }
        })
    }

    function MarkBand() {
        var DepartId = 5;

        $.ajax({
            url: "/Project/BandProjectbinding",
            data: {
                DepartId: DepartId
            },
            type: "post",
            datatype: "json",
            success: function (res) {
                var list = "";
                $(res.info).each(function () {
                    list += "<option value='" + this.Id + "' >" + this.PositName + "</option>";
                })
                $("#selMark").append(list);
            }
        })
    }

    function ExitProject() {
        window.location = "/Project/InfoMation";
    }

    
    
    function StageDetail() {
        var ProjectId = $("#hidProjectId").val();
                
            $.ajax({
            url: "/Project/StageDetail",
            data: {
                ProjectStageId:ProjectId
            },
            datatype: "Json",
            type:"Post",
            success: function (res) {
                var list = "";
                $(res.Stage).each(function () {
                    list += "<tr>" +
                        "<td>" + this.PlanId + "</td>" +
                        "<td>" + this.StageName + "</td>" +
                        "<td>" +ChangeDateFormat(this.StageStartTime) + "</td>" +
                        "<td>" +ChangeDateFormat(this.StageFinishTime) + "</td>" +
                        "<td>" + this.StageStaffName + "</td>" +
                        "<td><a onclick='StageDelete("+this.PlanId+")' >删除</a>"+"</td>"+
                        "<td><a onclick='StageUpdtae("+this.PlanId+")' >修改</a>"+"</td>"+
                        "</tr>";  
                })
                $("#tby").append(list);

              
            }
        })
    }

    function AddStage() {
        var ProjectId = $("#hidProjectId").val();

        window.location = "/Project/StageUpdate?ProjectStage="+ProjectId;
    }
</script>
